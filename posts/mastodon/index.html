<!doctype html><html lang=en-US dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Mastodon | yányào.com</title>
<link rel=stylesheet href=/css/main.min.8e8195eddcd5aefb03915f2af14e3db65c508a85859da96a19e43823f3c590fd.css integrity="sha256-joGV7dzVrvsDkV8q8U49tlxQioWFnalqGeQ4I/PFkP0=" crossorigin=anonymous></head><body><header><header><a href=https://xn--ynyo-2nad.com/ class=title><h2>yányào.com</h2></a><nav><a href=/>Home</a>
<a href=/posts>Posts</a>
<a href=/index.xml>RSS</a></nav></header><main><h1>Mastodon</h1><time datetime=2020-05-15T09:45:08+08:00>May 15, 2020</time><p><code>Mastodon 长毛象</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> &ndash; 基于 rubyonrails/reactjs/nodejs 开发的分布式 &
去中心化 twiter clone。利用空闲时间在 aws lightsail 上开了个实例把服务跑了起来</p><p>一开始走了些弯路，因为选机房和省钱的缘故，重建了若干次操作系统，最后的选择是
tokyo+cloudflare，没错我又套了 cdn，实在是海外线路到北京联通不稳定</p><p>安装步骤没有使用 docker 而是参考文档从源码安装<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>，原因和解决方案如下：</p><ul><li><p><del>机器用 $3.5/mo 512mem 最便宜的那档消费降级</del>(512M 内存重启会拉垮弱鸡，服务已迁移到 oraclecloud)，出于 net/io 性能考虑就不使 docker 啦</p></li><li><p>内存问题，<code>RAILS_ENV=production bundle exec rake mastodon:setup</code>
这一步骤执行到 <code>rails assets:precompile</code>，
不管是在 docker 里跑还是直接运行都会报 swap 分区不足，找到两个方案来解决:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># create swapfile &lt;https://linuxize.com/post/create-a-linux-swap-file/&gt;</span>
</span></span><span style=display:flex><span>$ sudo fallocate -l 2G /swapfile
</span></span><span style=display:flex><span>$ sudo chmod <span style=color:#ae81ff>600</span> /swapfile
</span></span><span style=display:flex><span>$ sudo mkswap /swapfile
</span></span><span style=display:flex><span>$ sudo swapon /swapfile
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># verify active</span>
</span></span><span style=display:flex><span>$ sudo swapon --show
</span></span><span style=display:flex><span><span style=color:#75715e># optional: low value is better for production</span>
</span></span><span style=display:flex><span>$ sudo sysctl vm.swappiness<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span></code></pre></div><h2 id=邮件配置>邮件配置</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># By default the memory limit in Node. js is 512 mb, </span>
</span></span><span style=display:flex><span><span style=color:#75715e># use command —- max-old-space-size to increase the memory limit</span>
</span></span><span style=display:flex><span>$ NODE_OPTIONS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;--max-old-space-size=4096&#34;</span> RAILS_ENV<span style=color:#f92672>=</span>production bundle exec rails assets:precompile
</span></span></code></pre></div><p>直接配置 localhost 发送邮件无效，先用 <a href=https://sendgrid.com/>sendgrid</a> 免费版顶着, 一天 100 封邮件目前够用</p><h2 id=迁移机器后重建-feed>迁移机器后重建 feed</h2><p>postgresql/redis 都换到了新机器, 之前因为 sidekiq 占用资源过多清理过 redis 数据, 相关 timeline 全都空了, 需要重建</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>RAILS_ENV<span style=color:#f92672>=</span>production ./bin/tootctl feeds build
</span></span></code></pre></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://github.com/tootsuite/mastodon>https://github.com/tootsuite/mastodon</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://github.com/tootsuite/documentation/blob/master/content/en/admin/install.md>https://github.com/tootsuite/documentation/blob/master/content/en/admin/install.md</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><div><div>Tags:</div><ul><li><a href=/blog/mastodon/>Mastodon</a></li><li><a href=/blog/decentralized/>Decentralized</a></li></ul></div></main><footer><p>Copyright 2025. All rights reserved.</p></footer></body></html>