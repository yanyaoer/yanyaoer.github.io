<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Degoogle on yányào.com</title><link>https://xn--ynyo-2nad.com/blog/degoogle/</link><description>Recent content in Degoogle on yányào.com</description><generator>Hugo</generator><language>en-US</language><lastBuildDate>Tue, 01 Dec 2020 20:34:44 +0800</lastBuildDate><atom:link href="https://xn--ynyo-2nad.com/blog/degoogle/index.xml" rel="self" type="application/rss+xml"/><item><title>Self Host Maddy Mail Server</title><link>https://xn--ynyo-2nad.com/posts/self-host-maddy-mail-server/</link><pubDate>Tue, 01 Dec 2020 20:34:44 +0800</pubDate><guid>https://xn--ynyo-2nad.com/posts/self-host-maddy-mail-server/</guid><description>&lt;h2 id="maddy">maddy&lt;/h2>
&lt;blockquote>
&lt;p>Composable all-in-one mail server. &lt;a href="https://github.com/foxcpp/maddy">https://github.com/foxcpp/maddy&lt;/a>&lt;/p>&lt;/blockquote>
&lt;p>准备自建系列服务替换掉 google 全家桶，先试了传统的 Postfix, Dovecot, OpenDKIM, OpenSPF, OpenDMARC 套餐，但是本人水平菜，机器配置也不高，折腾两天还没跑起来，正好看到订阅的 changelog 推荐了 maddy &lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> 于是搓搓手气试试这个邮局方案，以下是满足个人喜好的优点&lt;/p>
&lt;ul>
&lt;li>基于 golang 生态依赖少，方便打镜像&lt;/li>
&lt;li>验证数据存在 sqlite 里也很轻量&lt;/li>
&lt;li>没有 web 端，只需要 imap + thunderbird 即可&lt;/li>
&lt;li>配置文件相对简单&lt;/li>
&lt;/ul>
&lt;h2 id="install">install&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>mkdir -p /data/maddy
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># hard link caddy&amp;#39;s crt and key to maddy&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ln var/lib/caddy/.local/share/caddy/certificates/acme-v02.api.letsencrypt.org-directory/&lt;span style="color:#e6db74">${&lt;/span>domain&lt;span style="color:#e6db74">}&lt;/span>/&lt;span style="color:#e6db74">${&lt;/span>domain&lt;span style="color:#e6db74">}&lt;/span>.crt /data/maddy/&lt;span style="color:#e6db74">${&lt;/span>domain&lt;span style="color:#e6db74">}&lt;/span>.crt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ln var/lib/caddy/.local/share/caddy/certificates/acme-v02.api.letsencrypt.org-directory/&lt;span style="color:#e6db74">${&lt;/span>domain&lt;span style="color:#e6db74">}&lt;/span>/&lt;span style="color:#e6db74">${&lt;/span>domain&lt;span style="color:#e6db74">}&lt;/span>.key /data/maddy/&lt;span style="color:#e6db74">${&lt;/span>domain&lt;span style="color:#e6db74">}&lt;/span>.key
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># foxcpp/maddy:v0.4.2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>podman run &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --name maddy &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -v /data/maddy:/data &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -p 25:25 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -p 143:143 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -p 587:587 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -p 993:993 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -p 465:465 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> yanyaoer/maddy:master
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># add user&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>podman run --rm -it -v /data/maddy:/data --entrypoint /bin/maddyctl yanyaoer/maddy:master creds create yanyao@mail.yadanhe.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>参考文档配置&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup> 完后发送邮件对方可收，本地 thunderbird 接收回复邮件时有问题&lt;/p>
&lt;ul>
&lt;li>&lt;input checked="" disabled="" type="checkbox"> spf 验证无法通过，暂时禁用待修复&lt;/li>
&lt;li>&lt;input checked="" disabled="" type="checkbox"> 接收时报错 &amp;ldquo;Unexpected EOF when reciving from Steam&amp;rdquo;，等 0.4.3 发布 &lt;sup id="fnref:3">&lt;a href="#fn:3" class="footnote-ref" role="doc-noteref">3&lt;/a>&lt;/sup>&lt;/li>
&lt;/ul>
&lt;h2 id="workaround">workaround&lt;/h2>
&lt;ul>
&lt;li>使用 master 分支打包镜像 maddy 0.5.0-dev15+ge4ad3bd 到 &lt;code>yanyaoer/maddy:master&lt;/code> 临时使用&lt;/li>
&lt;li>go 1.15.5 打包镜像时报错 &lt;code>go build runtime/cgo: invalid flag in go:cgo_ldflag: -Wl,-z,relro,-z,now&lt;/code>，在 builds.sh 里添加参数通过 &lt;sup id="fnref:4">&lt;a href="#fn:4" class="footnote-ref" role="doc-noteref">4&lt;/a>&lt;/sup>&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>diff --git a/build.sh b/build.sh
index a76f6b6..b6e2eb2 100755
--- a/build.sh
+++ b/build.sh
@@ -119,6 +119,7 @@ read_config() {
 export MADDY_SRC=
 fi

+ export CGO_LDFLAGS_ALLOW=&amp;#39;-Wl,-z,relro,-z,now&amp;#39;
 export CGO_CFLAGS=&amp;#34;-g -O2 -D_FORTIFY_SOURCE=2 $CFLAGS&amp;#34;
 export CGO_CXXFLAGS=&amp;#34;-g -O2 -D_FORTIFY_SOURCE=2 $CXXFLAGS&amp;#34;
 export LDFLAGS=&amp;#34;-Wl,-z,relro,-z,now $LDFLAGS&amp;#34;
&lt;/code>&lt;/pre>&lt;p>** update: 2021-07-23 **
&lt;a href="https://github.com/foxcpp/maddy/releases/tag/v0.4.4">v0.4.4&lt;/a>
直接下载解压以上功能正常使用，不再使用 podman 部署&lt;/p>
&lt;h2 id="alternative">alternative&lt;/h2>
&lt;p>以下方案不太合口味，日后有缘再试&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/sovereign/sovereign">https://github.com/sovereign/sovereign&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/ajgon/self-hosted-mailserver/blob/master/docs/nsa-proof-your-e-mail-in-2-hours.md">https://github.com/ajgon/self-hosted-mailserver/blob/master/docs/nsa-proof-your-e-mail-in-2-hours.md&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/Mailu/Mailu">https://github.com/Mailu/Mailu&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/mailcow/mailcow-dockerized">https://github.com/mailcow/mailcow-dockerized&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/tonioo/modoboa">https://github.com/tonioo/modoboa&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/sovereign/sovereign">https://github.com/sovereign/sovereign&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/mail-in-a-box/mailinabox">https://github.com/mail-in-a-box/mailinabox&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/iredmail/iRedMail">https://github.com/iredmail/iRedMail&lt;/a>&lt;/li>
&lt;/ul>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>&lt;a href="https://changelog.com/news/maddy-a-composable-allinone-mail-server-ljEe">https://changelog.com/news/maddy-a-composable-allinone-mail-server-ljEe&lt;/a>&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2">
&lt;p>&lt;a href="https://foxcpp.dev/maddy/tutorials/setting-up/">https://foxcpp.dev/maddy/tutorials/setting-up/&lt;/a>&amp;#160;&lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:3">
&lt;p>&lt;a href="https://github.com/foxcpp/maddy/issues/300">https://github.com/foxcpp/maddy/issues/300&lt;/a>&amp;#160;&lt;a href="#fnref:3" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:4">
&lt;p>&lt;a href="https://github.com/foxcpp/maddy/issues/299#issuecomment-735862091">https://github.com/foxcpp/maddy/issues/299#issuecomment-735862091&lt;/a>&amp;#160;&lt;a href="#fnref:4" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item></channel></rss>